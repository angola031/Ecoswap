#!/usr/bin/env node

/**
 * Script para verificar la configuración de envío de emails de administradores en Vercel
 */

console.log('🔧 Verificando configuración de emails de administradores en Vercel...\n')

console.log('📋 Configuración requerida en Vercel:')
console.log()

console.log('1. 🔑 Environment Variables en Vercel:')
console.log('   - SUPABASE_SERVICE_ROLE_KEY: [debe estar configurada]')
console.log('   - NEXT_PUBLIC_SUPABASE_URL: [debe estar configurada]')
console.log('   - NEXT_PUBLIC_SUPABASE_ANON_KEY: [debe estar configurada]')
console.log()

console.log('2. 📧 Configuración de Email en Supabase:')
console.log('   - Authentication → Settings → Email')
console.log('   - "Enable email confirmations": ✅ Activado')
console.log('   - "Enable email change confirmations": ✅ Activado')
console.log('   - SMTP Configuration: [si usas proveedor personalizado]')
console.log()

console.log('3. 🌐 URLs de Redirección en Supabase:')
console.log('   - Site URL: https://ecoswap-lilac.vercel.app')
console.log('   - Redirect URLs:')
console.log('     * https://ecoswap-lilac.vercel.app/auth/supabase-redirect')
console.log('     * https://ecoswap-lilac.vercel.app/auth/callback')
console.log('     * https://ecoswap-lilac.vercel.app/auth/reset-password')
console.log()

console.log('4. 🔄 Flujo de Creación de Administrador:')
console.log('   1. Usuario crea admin desde dashboard')
console.log('   2. API /api/admin/roles recibe la petición')
console.log('   3. Se crea el usuario en tabla usuario')
console.log('   4. Se asignan roles en tabla usuario_rol')
console.log('   5. Se llama a supabase.auth.resetPasswordForEmail()')
console.log('   6. Supabase envía email con enlace de configuración')
console.log('   7. Usuario hace clic en enlace y establece contraseña')
console.log()

console.log('📊 Logs esperados en Vercel Functions:')
console.log('✅ API Create Admin: Cliente admin creado correctamente')
console.log('📧 API Create Admin: Enviando email a: [email]')
console.log('🔗 API Create Admin: URL de redirección: [url]')
console.log('✅ API Create Admin: Email de configuración enviado exitosamente')
console.log()

console.log('❌ Logs de error comunes:')
console.log('❌ API Create Admin: No se pudo crear cliente admin')
console.log('   → Service Role Key no configurada o incorrecta')
console.log('❌ API Create Admin: Error enviando email: Invalid redirect URL')
console.log('   → URLs de redirección no configuradas en Supabase')
console.log('❌ API Create Admin: Error enviando email: User not found')
console.log('   → Usuario no existe en Supabase Auth')
console.log('❌ API Create Admin: Error enviando email: Email rate limit')
console.log('   → Demasiados emails enviados, esperar')
console.log()

console.log('🛠️  Pasos para diagnosticar:')
console.log('1. Crear un administrador desde https://ecoswap-lilac.vercel.app/admin/verificaciones')
console.log('2. Revisar logs en Vercel Dashboard → Functions → [función] → Logs')
console.log('3. Revisar logs en Supabase Dashboard → Logs → Auth')
console.log('4. Verificar que el email llegue a la bandeja de entrada')
console.log('5. Verificar que el enlace del email funcione correctamente')
console.log()

console.log('🧪 Prueba específica:')
console.log('1. Usar un email que NO exista en Supabase Auth')
console.log('2. Crear el administrador desde el dashboard')
console.log('3. Verificar logs en Vercel')
console.log('4. Verificar que llegue el email')
console.log('5. Hacer clic en el enlace y verificar que funcione')
console.log()

console.log('🔍 Verificaciones adicionales:')
console.log('1. ¿El usuario ya existe en Supabase Auth?')
console.log('   - Si existe, resetPasswordForEmail puede fallar')
console.log('   - Solución: Usar email diferente o eliminar usuario existente')
console.log()
console.log('2. ¿Las URLs de redirección están configuradas?')
console.log('   - Verificar en Supabase Dashboard → Authentication → URL Configuration')
console.log('   - Debe incluir todas las URLs de redirección')
console.log()
console.log('3. ¿El Service Role Key tiene permisos?')
console.log('   - Verificar que esté configurada correctamente en Vercel')
console.log('   - Verificar que no tenga espacios o caracteres extra')
console.log()

console.log('📞 Si el problema persiste:')
console.log('1. Verificar logs detallados en Vercel y Supabase')
console.log('2. Probar con un email completamente nuevo')
console.log('3. Verificar configuración de SMTP en Supabase')
console.log('4. Contactar soporte de Supabase si es problema de email')
console.log()

console.log('🔗 URLs útiles:')
console.log('- Vercel Dashboard: https://vercel.com/dashboard')
console.log('- Supabase Dashboard: https://supabase.com/dashboard')
console.log('- Tu proyecto Vercel: [buscar en Vercel Dashboard]')
console.log('- Tu proyecto Supabase: [buscar en Supabase Dashboard]')
console.log()

console.log('💡 Nota importante:')
console.log('El envío de emails funciona con Service Role Key en Vercel.')
console.log('Localmente puede no funcionar si no tienes la Service Role Key.')
console.log('Para probar completamente, usa la versión desplegada en Vercel.')
