#!/usr/bin/env node

/**
 * Script para verificar la configuraciÃ³n de envÃ­o de emails de administradores en Vercel
 */

console.log('ğŸ”§ Verificando configuraciÃ³n de emails de administradores en Vercel...\n')

console.log('ğŸ“‹ ConfiguraciÃ³n requerida en Vercel:')
console.log()

console.log('1. ğŸ”‘ Environment Variables en Vercel:')
console.log('   - SUPABASE_SERVICE_ROLE_KEY: [debe estar configurada]')
console.log('   - NEXT_PUBLIC_SUPABASE_URL: [debe estar configurada]')
console.log('   - NEXT_PUBLIC_SUPABASE_ANON_KEY: [debe estar configurada]')
console.log()

console.log('2. ğŸ“§ ConfiguraciÃ³n de Email en Supabase:')
console.log('   - Authentication â†’ Settings â†’ Email')
console.log('   - "Enable email confirmations": âœ… Activado')
console.log('   - "Enable email change confirmations": âœ… Activado')
console.log('   - SMTP Configuration: [si usas proveedor personalizado]')
console.log()

console.log('3. ğŸŒ URLs de RedirecciÃ³n en Supabase:')
console.log('   - Site URL: https://ecoswap-lilac.vercel.app')
console.log('   - Redirect URLs:')
console.log('     * https://ecoswap-lilac.vercel.app/auth/supabase-redirect')
console.log('     * https://ecoswap-lilac.vercel.app/auth/callback')
console.log('     * https://ecoswap-lilac.vercel.app/auth/reset-password')
console.log()

console.log('4. ğŸ”„ Flujo de CreaciÃ³n de Administrador:')
console.log('   1. Usuario crea admin desde dashboard')
console.log('   2. API /api/admin/roles recibe la peticiÃ³n')
console.log('   3. Se crea el usuario en tabla usuario')
console.log('   4. Se asignan roles en tabla usuario_rol')
console.log('   5. Se llama a supabase.auth.resetPasswordForEmail()')
console.log('   6. Supabase envÃ­a email con enlace de configuraciÃ³n')
console.log('   7. Usuario hace clic en enlace y establece contraseÃ±a')
console.log()

console.log('ğŸ“Š Logs esperados en Vercel Functions:')
console.log('âœ… API Create Admin: Cliente admin creado correctamente')
console.log('ğŸ“§ API Create Admin: Enviando email a: [email]')
console.log('ğŸ”— API Create Admin: URL de redirecciÃ³n: [url]')
console.log('âœ… API Create Admin: Email de configuraciÃ³n enviado exitosamente')
console.log()

console.log('âŒ Logs de error comunes:')
console.log('âŒ API Create Admin: No se pudo crear cliente admin')
console.log('   â†’ Service Role Key no configurada o incorrecta')
console.log('âŒ API Create Admin: Error enviando email: Invalid redirect URL')
console.log('   â†’ URLs de redirecciÃ³n no configuradas en Supabase')
console.log('âŒ API Create Admin: Error enviando email: User not found')
console.log('   â†’ Usuario no existe en Supabase Auth')
console.log('âŒ API Create Admin: Error enviando email: Email rate limit')
console.log('   â†’ Demasiados emails enviados, esperar')
console.log()

console.log('ğŸ› ï¸  Pasos para diagnosticar:')
console.log('1. Crear un administrador desde https://ecoswap-lilac.vercel.app/admin/verificaciones')
console.log('2. Revisar logs en Vercel Dashboard â†’ Functions â†’ [funciÃ³n] â†’ Logs')
console.log('3. Revisar logs en Supabase Dashboard â†’ Logs â†’ Auth')
console.log('4. Verificar que el email llegue a la bandeja de entrada')
console.log('5. Verificar que el enlace del email funcione correctamente')
console.log()

console.log('ğŸ§ª Prueba especÃ­fica:')
console.log('1. Usar un email que NO exista en Supabase Auth')
console.log('2. Crear el administrador desde el dashboard')
console.log('3. Verificar logs en Vercel')
console.log('4. Verificar que llegue el email')
console.log('5. Hacer clic en el enlace y verificar que funcione')
console.log()

console.log('ğŸ” Verificaciones adicionales:')
console.log('1. Â¿El usuario ya existe en Supabase Auth?')
console.log('   - Si existe, resetPasswordForEmail puede fallar')
console.log('   - SoluciÃ³n: Usar email diferente o eliminar usuario existente')
console.log()
console.log('2. Â¿Las URLs de redirecciÃ³n estÃ¡n configuradas?')
console.log('   - Verificar en Supabase Dashboard â†’ Authentication â†’ URL Configuration')
console.log('   - Debe incluir todas las URLs de redirecciÃ³n')
console.log()
console.log('3. Â¿El Service Role Key tiene permisos?')
console.log('   - Verificar que estÃ© configurada correctamente en Vercel')
console.log('   - Verificar que no tenga espacios o caracteres extra')
console.log()

console.log('ğŸ“ Si el problema persiste:')
console.log('1. Verificar logs detallados en Vercel y Supabase')
console.log('2. Probar con un email completamente nuevo')
console.log('3. Verificar configuraciÃ³n de SMTP en Supabase')
console.log('4. Contactar soporte de Supabase si es problema de email')
console.log()

console.log('ğŸ”— URLs Ãºtiles:')
console.log('- Vercel Dashboard: https://vercel.com/dashboard')
console.log('- Supabase Dashboard: https://supabase.com/dashboard')
console.log('- Tu proyecto Vercel: [buscar en Vercel Dashboard]')
console.log('- Tu proyecto Supabase: [buscar en Supabase Dashboard]')
console.log()

console.log('ğŸ’¡ Nota importante:')
console.log('El envÃ­o de emails funciona con Service Role Key en Vercel.')
console.log('Localmente puede no funcionar si no tienes la Service Role Key.')
console.log('Para probar completamente, usa la versiÃ³n desplegada en Vercel.')
